<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>My Site</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>body{font:18px/1.6 system-ui,Arial;padding:24px} button{font:16px;padding:8px 14px}</style>
</head>
<body>
  <h1>My Site</h1>
  <p id="status">Not signed in</p>
  <p>
    <button id="loginBtn">Sign in</button>
    <button id="logoutBtn" style="display:none">Sign out</button>
  </p>

<script>
  // ====== 設定（必ず置き換え） ======
  const USER_POOL_DOMAIN = "https://titti.auth.ap-northeast-1.amazoncognito.com";
  const CLIENT_ID = "5gaeq8057ds9puocgl29ej60qp";
  const REDIRECT_URI = "https://d271qmc6nzrst9.cloudfront.net/auth/callback.html";

  // 小道具
  const random = (len)=>btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(len))))
    .replace(/[^a-zA-Z0-9]/g,"").slice(0,len);
  async function sha256b64url(str){
    const buf=new TextEncoder().encode(str);
    const hash=await crypto.subtle.digest('SHA-256',buf);
    return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }

  async function startLogin(){
    // 既存の値を一旦クリア（取り違え防止）
    localStorage.removeItem("pkce_verifier");
    localStorage.removeItem("oauth_state");

    const codeVerifier = random(64);
    const codeChallenge = await sha256b64url(codeVerifier);
    const state = random(24);

    localStorage.setItem("pkce_verifier", codeVerifier);
    localStorage.setItem("oauth_state", state);

    // デバッグ表示
    console.log("[LOGIN] set pkce_verifier len=", codeVerifier.length);
    console.log("[LOGIN] set oauth_state =", state);

    const url = new URL(USER_POOL_DOMAIN + "/oauth2/authorize");
    url.searchParams.set("client_id", CLIENT_ID);
    url.searchParams.set("response_type", "code");
    url.searchParams.set("scope", "openid email profile");
    url.searchParams.set("redirect_uri", REDIRECT_URI);
    url.searchParams.set("code_challenge_method", "S256");
    url.searchParams.set("code_challenge", codeChallenge);
    url.searchParams.set("state", state);

    // 同一タブで遷移（新規タブだと session 周りが怪しくなることがある）
    window.location.href = url.toString();
  }

  document.getElementById("loginBtn").onclick = startLogin;

  // デバッグ：今の localStorage の中身
  console.log("[INDEX] existing id_token?", !!localStorage.getItem("id_token"));
  console.log("[INDEX] existing pkce_verifier?", !!localStorage.getItem("pkce_verifier"));
  console.log("[INDEX] existing oauth_state?", localStorage.getItem("oauth_state"));
</script>
</body>
</html>



