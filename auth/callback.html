<!doctype html>
<html>
<head><meta charset="utf-8"><title>Auth Callback</title></head>
<body>
<script>
  // ====== 設定（index.htmlと同じに揃える） ======
  const USER_POOL_DOMAIN = "https://ap-northeast-1mnfuoun8z.auth.ap-northeast-1.amazoncognito.com";
  const CLIENT_ID = "5gaeq8057ds9puocgl29ej60qp";
  const REDIRECT_URI = "https://d271qmc6nzrst9.cloudfront.net/auth/callback.html";

  async function exchangeToken(code){
    const codeVerifier = sessionStorage.getItem("pkce_verifier");
    if(!code || !codeVerifier){ alert("PKCE state lost. Try login again."); location.href="/"; return; }
    const body = new URLSearchParams({
      grant_type: "authorization_code",
      client_id: CLIENT_ID,
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: codeVerifier
    });
    const res = await fetch(USER_POOL_DOMAIN+"/oauth2/token", {
      method: "POST",
      headers: { "Content-Type":"application/x-www-form-urlencoded" },
      body
    });
    if(!res.ok){ console.error(await res.text()); alert("Token exchange failed"); location.href="/"; return; }
    const json = await res.json();
    // id_token を保存してトップへ戻る
    localStorage.setItem("id_token", json.id_token);
    location.href = "/";
  }

  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  exchangeToken(code);
</script>
</body>
</html>
