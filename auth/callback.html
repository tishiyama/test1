<!doctype html>
<html>
<head><meta charset="utf-8"><title>Auth Callback</title></head>
<body>
<script>
  const USER_POOL_DOMAIN = "https://ap-northeast-1mnfuoun8z.auth.ap-northeast-1.amazoncognito.com";
  const CLIENT_ID = "5gaeq8057ds9puocgl29ej60qp";
  const REDIRECT_URI = "https://d271qmc6nzrst9.cloudfront.net/auth/callback.html";
  const HOME = "https://d271qmc6nzrst9.cloudfront.net/";

  async function exchangeToken(code){
    const codeVerifier = localStorage.getItem("pkce_verifier");
    const expectedState = localStorage.getItem("oauth_state");
    const returnedState = new URLSearchParams(location.search).get("state");

    // state/Verifier をチェック
    if (!code || !codeVerifier || !returnedState || returnedState !== expectedState) {
      alert("PKCE state lost. Try login again.");
      location.href = HOME;
      return;
    }

    const body = new URLSearchParams({
      grant_type: "authorization_code",
      client_id: CLIENT_ID,
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: codeVerifier
    });
    const res = await fetch(USER_POOL_DOMAIN + "/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });
    if (!res.ok) {
      console.error(await res.text());
      alert("Token exchange failed");
      location.href = HOME;
      return;
    }
    const json = await res.json();

    // 後始末（使い捨て）
    localStorage.removeItem("pkce_verifier");
    localStorage.removeItem("oauth_state");

    localStorage.setItem("id_token", json.id_token);
    location.href = HOME;
  }

  const params = new URLSearchParams(location.search);
  exchangeToken(params.get("code"));
</script>
</body>
</html>
