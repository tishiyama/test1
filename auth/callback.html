<!doctype html>
<html>
<head><meta charset="utf-8"><title>Auth Callback (debug)</title></head>
<body style="font:16px/1.5 system-ui,Arial;padding:16px">
<pre id="log" style="white-space:pre-wrap"></pre>
<script>
  const USER_POOL_DOMAIN = "https://titti.auth.ap-northeast-1.amazoncognito.com";
  const CLIENT_ID = "5gaeq8057ds9puocgl29ej60qp";
  const REDIRECT_URI = "https://d271qmc6nzrst9.cloudfront.net/auth/callback.html";
  const HOME = "https://d271qmc6nzrst9.cloudfront.net/";

  (async () => {
    const q = new URLSearchParams(location.search);
    const code = q.get("code");
    const state = q.get("state");
    if (!code) { alert("No code"); location.href = HOME; return; }

    // 保存から取得（localStorageを使用していること）
    const verifier = localStorage.getItem("pkce_verifier");
    const expectedState = localStorage.getItem("oauth_state");
    if (!verifier || !state || state !== expectedState) {
      alert("PKCE state/verifier missing or mismatch");
      location.href = HOME; return;
    }

    const body = new URLSearchParams({
      grant_type: "authorization_code",
      client_id: CLIENT_ID,
      code,
      redirect_uri: REDIRECT_URI,
      code_verifier: verifier
    });

    const res = await fetch(USER_POOL_DOMAIN + "/oauth2/token", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body
    });

    if (!res.ok) {
      const text = await res.text();
      alert("TOKEN ERROR:\n" + text);
      console.log("token error:", text);
      return;
    }

    const json = await res.json();
    localStorage.removeItem("pkce_verifier");
    localStorage.removeItem("oauth_state");
    localStorage.setItem("id_token", json.id_token);
    location.href = HOME;
  })();
</script>

</body>
</html>

